<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>è‹±èªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° PRO ğŸ¸</title>

  <!-- ã‚¹ãƒãƒ›æœ€é©åŒ–ï¼†iPhoneãƒ›ãƒ¼ãƒ ç”»é¢ã‚¢ãƒ—ãƒªç”¨ -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="è‹±èªãƒˆãƒ¬PRO">
  <meta name="theme-color" content="#f4fbff">

  <!-- iOS Web App ã‚¢ã‚¤ã‚³ãƒ³ï¼†ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆPCã§ã¯ãŸã ã®ãƒªãƒ³ã‚¯ï¼‰ -->
  <link rel="apple-touch-icon" href="icon-512.png">
  <link rel="apple-touch-startup-image"
        href="splash-1284x2778-notext.png"
        media="screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">

  <style>
    :root {
      --bg-gradient-start: #f4fbff;
      --bg-gradient-end: #fef6ff;
      --accent-main: #6ac3b3;
      --accent-sub: #ffb3c6;
      --accent-deep: #4a9d8f;
      --text-main: #333;
      --text-soft: #777;
      --card-bg: #ffffff;
      --border-soft: #e4edf5;
      --danger: #ff6b6b;
      --warn: #ffb347;
      --ok: #3cb371;
    }

    * { box-sizing: border-box; }

    html, body {
      height: 100%;
      overscroll-behavior: none;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
      display: flex;
      justify-content: center;
      align-items: flex-start; /* ã‚¹ãƒãƒ›ã¯ä¸Šå¯„ã› */
      padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom);
      color: var(--text-main);
      font-size: 17px;
      line-height: 1.5;
    }

    .app {
      width: 100%;
      max-width: 640px;
      padding: 10px 10px 16px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
      padding: 14px 16px 18px;
      position: relative;
      overflow: hidden;
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    h1 {
      font-size: 1.3rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    h1 .emoji { font-size: 1.8rem; }

    .mode-tag {
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(106, 195, 179, 0.12);
      color: var(--accent-deep);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .mode-tag-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--accent-main);
    }

    .csv-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .csv-row input[type="file"] {
      font-size: 0.8rem;
    }

    .csv-status {
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    #counter {
      font-size: 0.8rem;
      color: var(--text-soft);
      text-align: right;
      margin-bottom: 4px;
    }

    .progress-wrap { margin-bottom: 8px; }
    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--text-soft);
      margin-bottom: 2px;
    }
    .progress-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #edf2f7;
      overflow: hidden;
    }
    .progress-value {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent-main), var(--accent-sub));
      transition: width 0.25s ease-out;
    }

    .block-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-bottom: 8px;
    }

    .block {
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.9);
    }

    .label {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .label .emoji { font-size: 1rem; }

    .ja-text, .en-text {
      font-size: 1.05rem;
      white-space: pre-wrap;
      line-height: 1.6;
    }

    .en-text.hidden {
      color: #bfc5cd;
      font-style: italic;
    }

    .checkbox-inline {
      margin-left: auto;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--text-soft);
    }

    .note-box {
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      background: #f7fffc;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      animation: fadeIn 0.25s ease-out;
      font-size: 0.85rem;
    }

    .note-icon { font-size: 1.2rem; }
    .note-text { font-size: 0.85rem; color: #444; line-height: 1.55; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .cheer-box {
      margin-top: 8px;
      padding: 10px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px dashed var(--border-soft);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      color: var(--text-soft);
    }
    .cheer-icon { font-size: 1.3rem; }

    .section {
      margin-top: 8px;
      padding-top: 4px;
      border-top: 1px dashed #e3ecf5;
    }

    .controls {
      margin-top: 6px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
    }

    button {
      border-radius: 12px;
      border: none;
      padding: 10px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: 0.15s;
      background: #f3f6fb;
      color: var(--text-main);
      box-shadow: 0 2px 4px rgba(15, 23, 42, 0.05);
    }

    button.primary {
      background: linear-gradient(135deg, var(--accent-main), var(--accent-deep));
      color: #fff;
    }

    button.accent {
      background: linear-gradient(135deg, var(--accent-sub), #ff9fb4);
      color: #fff;
    }

    button.toggled {
      box-shadow: 0 0 0 2px rgba(106, 195, 179, 0.5);
      background: #e6fffa;
      color: var(--accent-deep);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 5px 10px rgba(15, 23, 42, 0.12);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 5px rgba(15, 23, 42, 0.1);
    }

    .speed-label {
      font-size: 0.85rem;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    #rateInfo {
      font-size: 0.85rem;
      font-weight: bold;
      color: var(--accent-deep);
    }

    .recog-result {
      margin-top: 8px;
      font-size: 0.8rem;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.9);
    }
    .recog-row { margin-bottom: 4px; }
    .recog-label {
      font-size: 0.75rem;
      color: var(--text-soft);
    }
    .recog-text {
      font-size: 0.85rem;
    }
    .recog-score {
      font-size: 0.85rem;
      font-weight: bold;
    }

    .score-good { color: var(--ok); }
    .score-mid { color: var(--warn); }
    .score-bad { color: var(--danger); }

    @media (max-width: 380px) {
      h1 { font-size: 1.15rem; }
      .ja-text, .en-text { font-size: 1rem; }
      button { font-size: 0.85rem; padding: 9px 12px; }
    }

    /* ğŸ–¥ PCãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šã“ã‚Œã¾ã§é€šã‚Šä¸­å¤®å¯„ã›ï¼†2ã‚«ãƒ©ãƒ ã«ã™ã‚‹ */
    @media (min-width: 900px) {
      body {
        align-items: center;
        padding-top: 0;
      }
      .app {
        max-width: 960px;
        padding: 16px;
      }
      .card {
        padding: 24px 28px 28px;
        border-radius: 20px;
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.06);
      }
      .block-row {
        grid-template-columns: 1.05fr 1.1fr;
        gap: 10px;
        margin-bottom: 10px;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      button {
        border-radius: 999px;
        font-size: 0.8rem;
        padding: 7px 14px;
        justify-content: flex-start;
      }
    }
	/* ã‚¹ãƒãƒ›ï¼ˆå¹…768pxä»¥ä¸‹ï¼‰ã®ã¨ãã¯ CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¡Œã‚’éè¡¨ç¤º */
@media (max-width: 768px) {
  .csv-row {
    display: none;
  }
}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="header-row">
        <h1><span class="emoji">ğŸ¸</span><span>è‹±èªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° PRO</span></h1>
        <div class="mode-tag">
          <span class="mode-tag-dot"></span>
          <span>ç¬é–“è‹±ä½œæ–‡ãƒ»ã‚·ãƒ£ãƒ‰ã‚¦ã‚¤ãƒ³ã‚°é“å ´</span>
        </div>
      </div>

      <div class="csv-row">
        <div>ğŸ“‚ CSVèª­ã¿è¾¼ã¿ï¼ˆja, en, note åˆ—ï¼‰:</div>
        <input type="file" id="csvInput" accept=".csv,.tsv,text/csv">
        <span id="csvStatus" class="csv-status">ï¼ˆæœªèª­ã¿è¾¼ã¿ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¾‹æ–‡ä½¿ç”¨ä¸­ï¼‰</span>
      </div>

      <div id="counter"></div>

      <div class="progress-wrap">
        <div class="progress-label">
          <span>ä»Šæ—¥ã®é€²æ—</span>
          <span id="progressText">0%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-value" id="progressValue"></div>
        </div>
      </div>

      <div class="block-row">
        <div class="block">
          <div class="label"><span class="emoji">ğŸ‡¯ğŸ‡µ</span><span>æ—¥æœ¬èª</span></div>
          <div id="jaText" class="ja-text"></div>
        </div>
        <div class="block">
          <div class="label">
            <span class="emoji">ğŸ‡¬ğŸ‡§</span><span>è‹±èª</span>
            <label class="checkbox-inline">
              <input type="checkbox" id="hideEn"> è‹±æ–‡ã‚’éš ã™
            </label>
          </div>
          <div id="enText" class="en-text"></div>
        </div>
      </div>

      <div id="noteBox" class="note-box" style="display:none;">
        <div class="note-icon">ğŸ’¡</div>
        <div id="noteText" class="note-text"></div>
      </div>

      <div class="cheer-box">
        <div class="cheer-icon">ğŸ¸</div>
        <div id="cheerText">ã‚ˆã†ã“ãè‹±èªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é“å ´ã¸ã€‚ã¾ãšã¯1æ–‡ã€å£°ã«å‡ºã—ã¦ã¿ã‚ˆã€œã€‚</div>
      </div>

      <div class="section">
        <div class="speed-label">
          <span>ğŸ§ è‹±èªã®é€Ÿåº¦ï¼š</span><span id="rateInfo">1.0xï¼ˆãµã¤ã†ï¼‰</span>
        </div>
        <div class="controls">
          <button id="rateSlow">ğŸ¢ ã‚†ã£ãã‚Š</button>
          <button id="rateNormal">âš–ï¸ ãµã¤ã†</button>
          <button id="rateFast">ğŸƒâ€â™€ï¸ ã¯ã‚„ã„</button>
        </div>
      </div>

      <div class="section">
        <div class="controls">
          <button id="btnPlayJa">ğŸ—£ï¸ æ—¥æœ¬èªã‚’èã</button>
          <button id="btnPlayEn" class="primary">ğŸ§ è‹±èªã‚’1å›èã</button>
          <button id="btnShadow" class="accent">ğŸ” ã‚·ãƒ£ãƒ‰ã‚¦ã‚¤ãƒ³ã‚°ï¼ˆ3å›ï¼‰</button>
        </div>
      </div>

      <div class="section">
        <div class="controls">
          <button id="btnRecog" class="primary">ğŸ™ï¸ è‹±èªã‚’è©±ã—ã¦ãƒã‚§ãƒƒã‚¯</button>
        </div>
        <div id="recogResult" class="recog-result" style="display:none;">
          <div class="recog-row">
            <div class="recog-label">ã‚ãªãŸã®ç™ºè©±ï¼ˆèªè­˜çµæœï¼‰</div>
            <div id="recogYour" class="recog-text"></div>
          </div>
          <div class="recog-row">
            <div class="recog-label">æ­£è§£ã®è‹±æ–‡</div>
            <div id="recogTarget" class="recog-text"></div>
          </div>
          <div class="recog-row">
            <div class="recog-label">é¡ä¼¼åº¦</div>
            <div id="recogScore" class="recog-score"></div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="controls">
          <button id="btnModeAll">ğŸ“š ãœã‚“ã¶</button>
          <button id="btnModeFavOnly">â­ ãŠæ°—ã«å…¥ã‚Šã®ã¿</button>
          <button id="btnModeReviewOnly">ğŸ”¥ è¦å¾©ç¿’ã®ã¿</button>
        </div>
      </div>

      <div class="section">
        <div class="controls">
          <button id="btnFav">â­ ãŠæ°—ã«å…¥ã‚Š</button>
          <button id="btnReview">ğŸ”¥ è¦å¾©ç¿’</button>
          <button id="btnRandom">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ </button>
          <button id="btnShowAnswer">âœ¨ ç­”ãˆã‚’è¡¨ç¤º</button>
          <button id="btnPrev">â¬…ï¸ å‰ã¸</button>
          <button id="btnNext">â¡ï¸ æ¬¡ã¸</button>
        </div>
      </div>

    </div>
  </div>

<script>
  const STORAGE_KEY = "piapiaStateV3";

  const defaultSentences = [
    {
      ja: "ã‚ãªãŸã¯å¹´ã®å‰²ã«è€ã‘ã¦è¦‹ãˆã‚‹",
      en: "You look old for your age.",
      note: "",
      favorite: false,
      review: false
    },
    {
      ja: "ã‚ãªãŸã¯æµ·ã®ãã°ã§é‡çƒã®è©¦åˆã‚’è¦‹ã‚‹",
      en: "You watch baseball games by the sea.",
      note: "",
      favorite: false,
      review: false
    },
    {
      ja: "ã“ã‚Œã¯ç´ æ•µãªè»Šã§ã™",
      en: "This is a nice car.",
      note: "nice ãŒ carï¼ˆåè©ï¼‰ã‚’ä¿®é£¾ã™ã‚‹ï¼å½¢å®¹è©",
      favorite: false,
      review: false
    },
    {
      ja: "åƒ•ã¯ä¸€ç”Ÿæ‡¸å‘½ã«ã€è‹±èªã‚’å‹‰å¼·ã™ã‚‹",
      en: "I study English hard.",
      note: "hard ãŒ studyï¼ˆå‹•è©ï¼‰ã‚’ä¿®é£¾ã™ã‚‹ï¼å‰¯è©",
      favorite: false,
      review: true
    },
    {
      ja: "ã‚ã®å®¶ã¯å¤§ãã„",
      en: "That house is big.",
      note: "å½¢å®¹è©ã¯ Cï¼ˆè£œèªï¼‰ã«ãªã‚Œã‚‹",
      favorite: true,
      review: false
    }
  ];

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      if (Array.isArray(obj)) {
        return { sentences: obj, isRandomMode: false, filterMode: "all" };
      }
      if (!obj || !Array.isArray(obj.sentences)) return null;
      return {
        sentences: obj.sentences.map(s => ({
          ja: s.ja || "",
          en: s.en || "",
          note: s.note || "",
          favorite: !!s.favorite,
          review: !!s.review
        })),
        isRandomMode: !!obj.isRandomMode,
        filterMode: obj.filterMode || "all"
      };
    } catch (e) {
      console.error(e);
      return null;
    }
  }

  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        sentences,
        isRandomMode,
        filterMode
      }));
    } catch (e) {
      console.error(e);
    }
  }

  const loaded = loadState();
  let sentences = loaded?.sentences || defaultSentences.slice();
  let isRandomMode = loaded?.isRandomMode || false;
  let filterMode = loaded?.filterMode || "all";

  let order = [];
  let currentIndex = 0;
  let speechRate = 1.0;

  const jaText = document.getElementById("jaText");
  const enText = document.getElementById("enText");
  const hideEnCheckbox = document.getElementById("hideEn");
  const counter = document.getElementById("counter");
  const rateInfo = document.getElementById("rateInfo");
  const progressText = document.getElementById("progressText");
  const progressValue = document.getElementById("progressValue");
  const noteBox = document.getElementById("noteBox");
  const noteText = document.getElementById("noteText");
  const cheerText = document.getElementById("cheerText");
  const csvStatus = document.getElementById("csvStatus");

  const btnFav = document.getElementById("btnFav");
  const btnReview = document.getElementById("btnReview");
  const btnRandom = document.getElementById("btnRandom");
  const btnModeAll = document.getElementById("btnModeAll");
  const btnModeFavOnly = document.getElementById("btnModeFavOnly");
  const btnModeReviewOnly = document.getElementById("btnModeReviewOnly");
  const btnRecog = document.getElementById("btnRecog");

  const recogResult = document.getElementById("recogResult");
  const recogYour = document.getElementById("recogYour");
  const recogTarget = document.getElementById("recogTarget");
  const recogScore = document.getElementById("recogScore");

  if (sentences.length > 0 && loaded) {
    csvStatus.textContent = `ï¼ˆä¿å­˜æ¸ˆã¿ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ ${sentences.length} æ–‡ã‚’èª­ã¿è¾¼ã¿æ¸ˆã¿ï¼‰`;
  }

  const cheerMessagesNeutral = [
    "ã„ã„æ„Ÿã˜ã„ã„æ„Ÿã˜ã€ãã®ãƒªã‚ºãƒ ã®ã¾ã¾ã„ã“ğŸ¸",
    "å£°ã«å‡ºã—ãŸè‡ªåˆ†ã‚’ã¾ãšè¤’ã‚ã‚ˆã†ã€‚ã‚«ã‚¨ãƒ«ã‚‚æ‹æ‰‹ã—ã¦ã‚‹ğŸ‘",
    "1æ–‡ãšã¤ã§OKã€‚ç©ã¿ä¸Šã’ãŸã¶ã‚“ã ã‘å£ãŒå‹æ‰‹ã«å‹•ãã‚ˆã†ã«ãªã‚‹ã‚ˆã€‚",
    "ã†ã¾ãè¨€ãˆãªãã¦ã‚‚OKã€‚è„³ã®é…ç·šã¯ä»Šã¤ãªãŒã‚Šä¸­ã€œğŸ§ ",
    "è‹±èªã®ãƒªã‚ºãƒ ã€ã¡ã‚‡ã£ã¨ãšã¤ä½“ã«å…¥ã£ã¦ãã¦ã‚‹ã‚ˆã€‚"
  ];
  const cheerMessagesGood = [
    "ãŠãŠã€œã‹ãªã‚Šè¿‘ã„ï¼ãã®èª¿å­ã§ã‚¬ãƒ³ã‚¬ãƒ³è¡Œã“ğŸ¸ğŸ”¥",
    "ã»ã¼å®Œç’§ï¼æ¬¡ã¯ã¡ã‚‡ã£ã¨ã‚¹ãƒ”ãƒ¼ãƒ‰ä¸Šã’ã¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã¿ã‚‹ï¼Ÿ",
    "ãƒŠã‚¤ã‚¹ã‚·ãƒ£ãƒ‰ã‚¦ã‚¤ãƒ³ã‚°ï¼ãƒªã‚ºãƒ ã‚‚ã„ã„æ„Ÿã˜ã ã‚ˆâœ¨",
    "è‹±èªè„³ã€ã¡ã‚ƒã‚“ã¨è‚²ã£ã¦ã‚‹â€¦ã‚«ã‚¨ãƒ«å¸«åŒ ã‚‚æ„Ÿå‹•ã—ã¦ã‚‹ğŸ˜­",
  ];
  const cheerMessagesReview = [
    "ã¡ã‚‡ã£ã¨é›£ã—ã‚ï¼Ÿã‚†ã£ãã‚Šãƒ¢ãƒ¼ãƒ‰ã§åˆ†è§£ã—ã¦æ”»ã‚ã‚ˆğŸ¢",
    "1å›ã§å®Œç’§ã˜ã‚ƒãªãã¦ã„ã„ã‚ˆã€‚åŒã˜æ–‡ã‚’ä½•å‘¨ã‚‚å›ã™ã®ãŒæ­£è§£ã€‚",
    "ã€Œè¦å¾©ç¿’ã€ã«å…¥ã‚Œã¦ãŠãï¼Ÿåå¾©ãŒã„ã¡ã°ã‚“å¼·ã„å‘³æ–¹ã ã‚ˆã€‚",
  ];

  function randomFrom(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }
  function setCheer(message) { cheerText.textContent = message; }
  function randomCheerNeutral() { setCheer(randomFrom(cheerMessagesNeutral)); }

  function makeOrder() {
    let base = [];
    for (let i = 0; i < sentences.length; i++) {
      const s = sentences[i];
      if (filterMode === "fav" && !s.favorite) continue;
      if (filterMode === "review" && !s.review) continue;
      base.push(i);
    }
    if (base.length === 0) return [];
    if (!isRandomMode) return base;
    return base
      .map(v => ({ v, sort: Math.random() }))
      .sort((a, b) => a.sort - b.sort)
      .map(obj => obj.v);
  }

  function initOrder() {
    order = makeOrder();
    if (order.length === 0) {
      if (filterMode !== "all") {
        filterMode = "all";
        saveState();
        order = makeOrder();
        setCheer("ã“ã®ãƒ¢ãƒ¼ãƒ‰ã«è©²å½“ã™ã‚‹æ–‡ãŒãªã‹ã£ãŸã®ã§ã€å…¨éƒ¨ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã—ãŸã‚ˆğŸ¸");
      }
    }
    if (order.length === 0 && sentences.length > 0) {
      order = [...Array(sentences.length).keys()];
    }
    currentIndex = 0;
  }

  function getRealIndex() {
    if (order.length === 0) return 0;
    return order[Math.min(Math.max(currentIndex, 0), order.length - 1)];
  }

  function updateRandomButton() {
    if (isRandomMode) {
      btnRandom.classList.add("toggled");
      btnRandom.textContent = "ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ä¸­";
    } else {
      btnRandom.classList.remove("toggled");
      btnRandom.textContent = "ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ";
    }
  }

  function updateFilterButtons() {
    btnModeAll.classList.toggle("toggled", filterMode === "all");
    btnModeFavOnly.classList.toggle("toggled", filterMode === "fav");
    btnModeReviewOnly.classList.toggle("toggled", filterMode === "review");
  }

  function updateProgress() {
    const total = order.length || sentences.length || 1;
    const percent = Math.round(((currentIndex + 1) / total) * 100);
    progressText.textContent = percent + "%";
    progressValue.style.width = percent + "%";
  }

  function updateFavButtons() {
    const s = sentences[getRealIndex()];
    if (s.favorite) {
      btnFav.classList.add("toggled");
      btnFav.textContent = "â­ ãŠæ°—ã«å…¥ã‚Šä¸­";
    } else {
      btnFav.classList.remove("toggled");
      btnFav.textContent = "â­ ãŠæ°—ã«å…¥ã‚Š";
    }

    if (s.review) {
      btnReview.classList.add("toggled");
      btnReview.textContent = "ğŸ”¥ è¦å¾©ç¿’ä¸­";
    } else {
      btnReview.classList.remove("toggled");
      btnReview.textContent = "ğŸ”¥ è¦å¾©ç¿’";
    }
  }

  function updateNote() {
    const note = sentences[getRealIndex()].note;
    if (note && note.trim() !== "") {
      noteText.textContent = note;
      noteBox.style.display = "flex";
    } else {
      noteBox.style.display = "none";
    }
  }

  function updateEnView() {
    const s = sentences[getRealIndex()];
    if (hideEnCheckbox.checked) {
      enText.textContent = "ï¼ˆè€³ã ã‘ã§å†ç¾ãƒãƒ£ãƒ¬ãƒ³ã‚¸ğŸ¸ï¼‰";
      enText.classList.add("hidden");
    } else {
      enText.textContent = s.en;
      enText.classList.remove("hidden");
    }
  }

  function updateView() {
    if (sentences.length === 0) {
      counter.textContent = "æ–‡ 0 / 0";
      jaText.textContent = "";
      enText.textContent = "";
      noteBox.style.display = "none";
      progressText.textContent = "0%";
      progressValue.style.width = "0%";
      return;
    }

    const realIdx = getRealIndex();
    const s = sentences[realIdx];
    const total = order.length || sentences.length;
    counter.textContent = `æ–‡ ${currentIndex + 1} / ${total}`;
    jaText.textContent = s.ja;

    updateEnView();
    updateNote();
    updateProgress();
    updateFavButtons();
    updateRandomButton();
    updateFilterButtons();
    randomCheerNeutral();
  }

  hideEnCheckbox.addEventListener("change", updateEnView);

  function speak(text, lang = "en-US") {
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang;
    u.rate = speechRate;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }

  document.getElementById("btnPlayJa").addEventListener("click", () => {
    speak(sentences[getRealIndex()].ja, "ja-JP");
  });

  document.getElementById("btnPlayEn").addEventListener("click", () => {
    speak(sentences[getRealIndex()].en, "en-US");
  });

  document.getElementById("btnShadow").addEventListener("click", () => {
    const s = sentences[getRealIndex()];
    const repeat = 3;
    const pauseMs = 1500;
    let count = 0;

    window.speechSynthesis.cancel();

    function playOnce() {
      if (count >= repeat) return;
      const u = new SpeechSynthesisUtterance(s.en);
      u.lang = "en-US";
      u.rate = speechRate;
      u.onend = () => {
        count++;
        if (count < repeat) {
          setTimeout(playOnce, pauseMs);
        } else {
          setCheer(randomFrom(cheerMessagesGood));
        }
      };
      window.speechSynthesis.speak(u);
    }
    playOnce();
  });

  document.getElementById("btnShowAnswer").addEventListener("click", () => {
    hideEnCheckbox.checked = false;
    updateEnView();
  });

  document.getElementById("btnNext").addEventListener("click", () => {
    const total = order.length || sentences.length;
    currentIndex = (currentIndex + 1) % total;
    recogResult.style.display = "none";
    updateView();
  });

  document.getElementById("btnPrev").addEventListener("click", () => {
    const total = order.length || sentences.length;
    currentIndex = (currentIndex - 1 + total) % total;
    recogResult.style.display = "none";
    updateView();
  });

  document.getElementById("rateSlow").addEventListener("click", () => {
    speechRate = 0.75;
    rateInfo.textContent = "0.75xï¼ˆã‚†ã£ãã‚Šï¼‰";
  });
  document.getElementById("rateNormal").addEventListener("click", () => {
    speechRate = 1.0;
    rateInfo.textContent = "1.0xï¼ˆãµã¤ã†ï¼‰";
  });
  document.getElementById("rateFast").addEventListener("click", () => {
    speechRate = 1.3;
    rateInfo.textContent = "1.3xï¼ˆã¯ã‚„ã„ï¼‰";
  });

  btnFav.addEventListener("click", () => {
    const realIdx = getRealIndex();
    const s = sentences[realIdx];
    s.favorite = !s.favorite;
    saveState();
    initOrder();
    updateView();
    setCheer(
      s.favorite
        ? "ã“ã®æ–‡ã€ãŠæ°—ã«å…¥ã‚Šå…¥ã‚Šã€œâ­ ä½•åº¦ã‚‚å£ã«å‡ºã—ã¦ä»²è‰¯ããªã‚ã†ã€‚"
        : "ãŠæ°—ã«å…¥ã‚Šè§£é™¤ã€‚ã§ã‚‚ã„ã¤ã§ã‚‚æˆ»ã£ã¦ãã¦ã„ã„ã‹ã‚‰ã­ğŸ¸"
    );
  });

  btnReview.addEventListener("click", () => {
    const realIdx = getRealIndex();
    const s = sentences[realIdx];
    s.review = !s.review;
    saveState();
    initOrder();
    updateView();
    setCheer(
      s.review
        ? randomFrom(cheerMessagesReview)
        : "è¦å¾©ç¿’ãƒªã‚¹ãƒˆã‹ã‚‰ä¸€æ—¦å’æ¥­ã€ãŠã‚ã§ã¨ã†ã€œğŸ‰"
    );
  });

  btnModeAll.addEventListener("click", () => {
    filterMode = "all";
    saveState();
    initOrder();
    updateView();
    setCheer("å…¨éƒ¨ãƒ¢ãƒ¼ãƒ‰ã€‚ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³å¤šã‚ã«å£ã‚’å‹•ã‹ã—ã¦ã„ã“ğŸ¸");
  });

  btnModeFavOnly.addEventListener("click", () => {
    filterMode = "fav";
    saveState();
    initOrder();
    updateView();
    setCheer("ãŠæ°—ã«å…¥ã‚Šã ã‘ãƒ¢ãƒ¼ãƒ‰ã€‚æ¨ã—ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ä½•åº¦ã‚‚å©ãè¾¼ã‚‚ã†ğŸ”¥");
  });

  btnModeReviewOnly.addEventListener("click", () => {
    filterMode = "review";
    saveState();
    initOrder();
    updateView();
    setCheer("è¦å¾©ç¿’ã ã‘ãƒ¢ãƒ¼ãƒ‰ã€‚å¼±ç‚¹é›†ä¸­ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã ã‚ˆğŸ¸ğŸ’ª");
  });

  btnRandom.addEventListener("click", () => {
    isRandomMode = !isRandomMode;
    initOrder();
    saveState();
    updateView();
    setCheer(
      isRandomMode
        ? "ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰ã¸ï¼ã©ã‚“ãªé †ç•ªã§æ¥ã¦ã‚‚å¯¾å¿œã§ãã‚‹ã®ãŒæœ¬å½“ã®è‹±èªåŠ›ğŸ¸ğŸ”¥"
        : "é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã£ãŸã‚ˆã€œã€‚æ–‡ã®æµã‚Œã§è¦šãˆãŸã„ã¨ãã«ã‚‚ãŠã™ã™ã‚ã€‚"
    );
  });

  function normalizeText(str) {
    return str
      .toLowerCase()
      .replace(/[^\w\s']/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function levenshtein(a, b) {
    const m = a.length, n = b.length;
    const dp = Array.from({ length: m + 1 }, () => new Array(n + 1).fill(0));
    for (let i = 0; i <= m; i++) dp[i][0] = i;
    for (let j = 0; j <= n; j++) dp[0][j] = j;
    for (let i = 1; i <= m; i++) {
      for (let j = 1; j <= n; j++) {
        const cost = a[i - 1] === b[j - 1] ? 0 : 1;
        dp[i][j] = Math.min(
          dp[i - 1][j] + 1,
          dp[i][j - 1] + 1,
          dp[i - 1][j - 1] + cost
        );
      }
    }
    return dp[m][n];
  }

  function similarityScore(a, b) {
    const na = normalizeText(a);
    const nb = normalizeText(b);
    if (!na && !nb) return 1;
    const dist = levenshtein(na, nb);
    const maxLen = Math.max(na.length, nb.length);
    return maxLen === 0 ? 1 : 1 - dist / maxLen;
  }

  let recognition = null;
  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (SpeechRec) {
    recognition = new SpeechRec();
    recognition.lang = "en-US";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
  } else {
    btnRecog.disabled = true;
    btnRecog.textContent = "ğŸ™ï¸ éŸ³å£°èªè­˜éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶";
    setCheer("éŸ³å£°èªè­˜ã¯ Chrome ãªã©å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ä½¿ãˆã‚‹ã‚ˆã€œğŸ¸");
  }

  btnRecog.addEventListener("click", () => {
    if (!recognition) {
      alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ãªã„ã¿ãŸã„ã§ã™ã€‚Chrome ãªã©ã‚’è©¦ã—ã¦ã¿ã¦ã­ã€‚");
      return;
    }
    setCheer("OKã€ãƒã‚¤ã‚¯ã§è‹±èªã‚’è¨€ã£ã¦ã¿ã¦ï¼éŒ²éŸ³ä¸­ã ã‚ˆğŸ™ï¸");
    recognition.start();
  });

  if (recognition) {
    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      const target = sentences[getRealIndex()].en;
      const score = similarityScore(transcript, target);
      const percent = Math.round(score * 100);
      recogYour.textContent = transcript;
      recogTarget.textContent = target;
      recogScore.textContent = `${percent}% ãã‚‰ã„ä¸€è‡´ã—ã¦ã‚‹ã‚ˆ`;

      recogScore.classList.remove("score-good", "score-mid", "score-bad");

      if (score >= 0.85) {
        recogScore.classList.add("score-good");
        setCheer(randomFrom(cheerMessagesGood));
      } else if (score >= 0.6) {
        recogScore.classList.add("score-mid");
        setCheer("ã‹ãªã‚Šè¿‘ã„ã‚ˆï¼ã‚‚ã†ä¸€å›ã ã‘ä¸å¯§ã«ã‚†ã£ãã‚Šè¨€ã£ã¦ã¿ã‚ˆğŸ¢");
      } else {
        recogScore.classList.add("score-bad");
        setCheer("å˜èªã‹èªé †ãŒã¡ã‚‡ã£ã¨ã‚ºãƒ¬ãŸã‹ã‚‚ã€‚åˆ†ã‘ã¦ã‚†ã£ãã‚Šè¨€ã£ã¦ã¿ã‚ˆã€œã€‚");
      }
      recogResult.style.display = "block";
    };

    recognition.onerror = (e) => {
      console.error(e);
      setCheer("ãƒã‚¤ã‚¯ã‚„æ¨©é™ã§ã‚¨ãƒ©ãƒ¼ã«ãªã£ãŸã¿ãŸã„ã€‚è¨­å®šã‚’ã¡ã‚‡ã£ã¨ç¢ºèªã—ã¦ã¿ã¦ã­ğŸ¸");
    };
  }

  function parseDelimitedLine(line) {
    if (line.includes("\t") && !line.includes(",")) {
      return line.split("\t");
    }
    return parseCSVLine(line);
  }

  function parseCSVLine(line) {
    const result = [];
    let current = "";
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const ch = line[i];

      if (ch === '"') {
        if (inQuotes && line[i + 1] === '"') {
          current += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (ch === "," && !inQuotes) {
        result.push(current);
        current = "";
      } else {
        current += ch;
      }
    }
    result.push(current);
    return result;
  }

  document.getElementById("csvInput").addEventListener("change", (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const text = e.target.result;
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
        if (lines.length < 2) {
          alert("æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿è¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
          return;
        }
        const header = parseDelimitedLine(lines[0]).map(h => h.trim().toLowerCase());
        const idxJa = header.indexOf("ja");
        const idxEn = header.indexOf("en");
        const idxNote = header.indexOf("note");
        if (idxJa === -1 || idxEn === -1) {
          alert("ãƒ˜ãƒƒãƒ€ãƒ¼ã« ja, en åˆ—ãŒå¿…è¦ã§ã™ã€‚note åˆ—ã¯ä»»æ„ã§ã™ã€‚");
          return;
        }

        const existingKeySet = new Set(
          sentences.map(s => `${s.ja}|||${s.en}`)
        );

        const added = [];
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i];
          if (!line.trim()) continue;

          const cols = parseDelimitedLine(line);

          const ja = (cols[idxJa] || "").trim();
          const en = (cols[idxEn] || "").trim();
          const note = idxNote >= 0 ? (cols[idxNote] || "").trim() : "";
          if (!ja || !en) continue;

          const key = `${ja}|||${en}`;
          if (existingKeySet.has(key)) continue;
          existingKeySet.add(key);
          added.push({
            ja,
            en,
            note,
            favorite: false,
            review: false
          });
        }

        if (added.length === 0) {
          alert("æ–°ã—ãè¿½åŠ ã§ãã‚‹æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ï¼ˆã™ã§ã«ç™»éŒ²æ¸ˆã¿ã‹ã‚‚ï¼‰");
          return;
        }

        sentences = sentences.concat(added);
        initOrder();
        saveState();
        const totalCount = sentences.length;
        csvStatus.textContent = `ï¼ˆCSV ã‹ã‚‰ ${added.length} æ–‡è¿½åŠ ï¼åˆè¨ˆ ${totalCount} æ–‡ï¼‰`;
        setCheer(`æ–°ã—ã„ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ ${added.length} æ–‡è¿½åŠ ã—ãŸã‚ˆï¼ã•ã£ããç·´ç¿’ã—ã‚ˆğŸ¸`);
        recogResult.style.display = "none";
        updateView();
      } catch (err) {
        console.error(err);
        alert("CSV ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      }
    };
    reader.readAsText(file, "utf-8");
  });

  initOrder();
  updateView();
</script>
</body>
</html>
